---
  - name: Install packages & copy configs
    hosts: rs

    tasks:
      - name: Update & install apt packages
        ansible.builtin.package:
          name:
            - bird2
            - python3-pip
            - python3-dev
            - python3-virtualenv
            - tmux
            - htop 
            - nftables
            - git
            - bgpq4
          state: latest
        become: true
      - name: Update & install pip packages
        ansible.builtin.pip:
          name: arouteserver

      - name: Fetch labix git repo
        ansible.builtin.git:
          repo: https://github.com/Hafpaf/labix.git
          dest: /home/user/labix
          clone: yes
          update: yes
      - name: Copy labix/arouteserver to ~/arouteserver
        ansible.builtin.copy:
          remote_src: true
          src: /home/user/labix/arouteserver/
          dest: /home/user/arouteserver
          mode: preserve

      - name: Create ARouteServer cache directory
        ansible.builtin.file:
          path: /home/user/arouteserver/cache
          state: directory
          mode: '0755'
      - name: Build config with ARouteServer
        ansible.builtin.shell:
          cmd: >
            arouteserver bird 
            --target-version 2.0.7 
            --cfg /home/user/arouteserver/arouteserver.yml 
            -o /etc/bird/bird.conf
        become: true
      - name: Configure bird
        ansible.builtin.shell:
          cmd: birdcl configure
        become: true
